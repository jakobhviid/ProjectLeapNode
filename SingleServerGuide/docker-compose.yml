version: "3"

services:
  zookeeper1:
    image: cfei/zookeeper:1.1.0
    container_name: zookeeper1
    restart: on-failure
    ports:
      - 2181:2181
    environment:
      ZOO_ID: 1
      ZOO_PORT: 2181
      ZOO_SERVERS: server.1=0.0.0.0:2888:3888,server.2=zookeeper2:2888:3888,server.3=zookeeper3:2888:3888
    volumes:
      - ./containervolumes/zookeeper1-data:/data/zookeeper
      - ./containervolumes/zookeeper1-logs:/datalogs/zookeeper

  zookeeper2:
    image: cfei/zookeeper:1.1.0
    container_name: zookeeper2
    restart: on-failure
    ports:
      - 2182:2181
    environment:
      ZOO_ID: 2
      ZOO_PORT: 2181
      ZOO_SERVERS: server.1=zookeeper1:2888:3888,server.2=0.0.0.0:2888:3888,server.3=zookeeper3:2888:3888
    volumes:
      - ./containervolumes/zookeeper2-data:/data/zookeeper
      - ./containervolumes/zookeeper2-logs:/datalogs/zookeeper

  zookeeper3:
    image: cfei/zookeeper:1.1.0
    container_name: zookeeper3
    restart: on-failure
    ports:
      - 2183:2181
    environment:
      ZOO_ID: 3
      ZOO_PORT: 2181
      ZOO_SERVERS: server.1=zookeeper1:2888:3888,server.2=zookeeper2:2888:3888,server.3=0.0.0.0:2888:3888
    volumes:
      - ./containervolumes/zookeeper3-data:/data/zookeeper
      - ./containervolumes/zookeeper3-logs:/datalogs/zookeeper

  kafka1:
    image: cfei/kafka:1.0.0
    container_name: kafka1
    restart: on-failure
    ports:
      - 9091:9091
      - 9092:9092
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper1:2181/kafka,zookeeper2:2181/kafka,zookeeper3:2181/kafka
      KAFKA_LISTENERS: INTERNAL://0.0.0.0:9091,EXTERNAL://0.0.0.0:9092
      KAFKA_ADVERTISED_LISTENERS: "INTERNAL://${HOST_DNS}:9091,EXTERNAL://${HOST_DNS}:9092"
      KAFKA_INTER_BROKER_LISTENER_NAME: INTERNAL
      KAFKA_HEAP_OPTS: "-Xmx${KAFKA_RAM}G"
    depends_on:
      - zookeeper1
      - zookeeper2
      - zookeeper3
    volumes:
      - ./containervolumes/kafka-data1:/data/kafka
      - ./containervolumes/kafka-logs1:/opt/kafka/logs

  kafka2:
    image: cfei/kafka:1.0.0
    container_name: kafka2
    restart: on-failure
    ports:
      - 9093:9093
      - 9094:9094
    environment:
      KAFKA_BROKER_ID: 2
      KAFKA_ZOOKEEPER_CONNECT: zookeeper1:2181/kafka,zookeeper2:2181/kafka,zookeeper3:2181/kafka
      KAFKA_LISTENERS: INTERNAL://0.0.0.0:9093,EXTERNAL://0.0.0.0:9094
      KAFKA_ADVERTISED_LISTENERS: "INTERNAL://${HOST_DNS}:9093,EXTERNAL://${HOST_DNS}:9094"
      KAFKA_INTER_BROKER_LISTENER_NAME: INTERNAL
      KAFKA_HEAP_OPTS: "-Xmx${KAFKA_RAM}G"
    depends_on:
      - zookeeper1
      - zookeeper2
      - zookeeper3
    volumes:
      - ./containervolumes/kafka-data2:/data/kafka
      - ./containervolumes/kafka-logs2:/opt/kafka/logs

  kafka3:
    image: cfei/kafka:1.0.0
    container_name: kafka3
    restart: on-failure
    ports:
      - 9095:9095
      - 9096:9096
    environment:
      KAFKA_BROKER_ID: 2
      KAFKA_ZOOKEEPER_CONNECT: zookeeper1:2181/kafka,zookeeper2:2181/kafka,zookeeper3:2181/kafka
      KAFKA_LISTENERS: INTERNAL://0.0.0.0:9095,EXTERNAL://0.0.0.0:9096
      KAFKA_ADVERTISED_LISTENERS: "INTERNAL://${HOST_DNS}:9095,EXTERNAL://${HOST_DNS}:9096"
      KAFKA_INTER_BROKER_LISTENER_NAME: INTERNAL
      KAFKA_HEAP_OPTS: "-Xmx${KAFKA_RAM}G"
    depends_on:
      - zookeeper1
      - zookeeper2
      - zookeeper3
    volumes:
      - ./containervolumes/kafka-data3:/data/kafka
      - ./containervolumes/kafka-logs3:/opt/kafka/logs

  interface-db:
    image: postgres
    container_name: interface-db
    restart: on-failure
    environment:
      POSTGRES_USER: "${DASHBOARD_DB_USER_NAME}"
      POSTGRES_PASSWORD: "${DASHBOARD_DB_USER_PASSWORD}"
      POSTGRES_DB: interface_db
    volumes:
      - ./containervolumes/interface-postgres-data:/var/lib/postgresql/data

  interface:
    image: cfei/dashboard-interface
    container_name: interface
    restart: on-failure
    ports:
      - 80:80
      - 5000:5000
    environment:
      DASHBOARDI_POSTGRES_CONNECTION_STRING: "Host=interface-db;Port=5432;Database=interface_db;Username=${DASHBOARD_DB_USER_NAME};Password=${DASHBOARD_DB_USER_PASSWORD}"
      DASHBOARDI_HOST_DNS: "http://${HOST_DNS}"
      DASHBOARDI_API_KEY: "${DASHBOARD_API_KEY}"
      DASHBOARDI_JWT_KEY: "${DASHBOARD_JWT_KEY}"
      DASHBOARDI_INIT_USER_EMAIL: "${DASHBOARD_USER_EMAIL}"
      DASHBAORDI_INIT_PASSWORD: "${DASHBOARD_USER_PASSWORD}"
      DASHBOARDI_JWT_ISSUER: "https://${HOST_DNS}:5000"
      DASHBOARDI_KAFKA_URL: kafka1:9092,kafka2:9094,kafka3:9096
    depends_on:
      - interface-db
      - kafka1
      - kafka2
      - kafka3

  dashboard-server:
    image: cfei/dashboard-server
    container_name: dashboard-server
    restart: on-failure
    environment:
      DASHBOARDS_SERVER_NAME: SingleServer
      DASHBOARDS_KAFKA_URL: kafka1:9092,kafka2:9094,kafka3:9096
    depends_on:
      - interface
      - kafka
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

# Wesley
  wesley-mysql:
    image: cfei/mysql
    container_name: wesley-mysql
    restart: on-failure
    environment:
      MYSQL_ROOT_PASSWORD: 532c5b0a-2cd9-4eed-ad10-6dcdea6e732b
      MYSQL_USER: archiver
      MYSQL_PASSWORD: c0d9f4f4-f978-4ff3-98a7-8a30a182bbd9
      MYSQL_DATABASE: metadata
    volumes:
      - ./containervolumes/wesley-mysql:/var/lib/mysql
      - ./containervolumes/wesley-mysql:/var/log

  cassandra1:
    image: cfei/cassandra:1.0.1
    container_name: container1
    restart: on-failure
    environment:
      CASSANDRA_CLUSTER_NAME: reference-cluster
      CASSANDRA_SEEDS: cassandra1,cassandra2
      CASSANDRA_ENDPOINT_SNITCH: GossipingPropertyFileSnitch
      CASSANDRA_BROADCAST_ADDRESS: "cassandra1"
      CASSANDRA_STORAGE_PORT: 7000
      CASSANDRA_AUTHENTICATOR: AllowAllAuthenticator
      CASSANDRA_AUTHORIZER: AllowAllAuthorizer
      CASSANDRA_DATACENTER: dc1Test
      CASSANDRA_RACK: rack1Test
      MAX_HEAP_SIZE: 1G
      HEAP_NEWSIZE: 200M
    volumes:
      - ./containervolumes/cassandra1/data:/opt/cassandra/data
      - ./containervolumes/cassandra1/logs:/opt/cassandra/logs

  cassandra2:
    image: cfei/cassandra:1.0.1
    container_name: container2
    restart: on-failure
    environment:
      CASSANDRA_CLUSTER_NAME: reference-cluster
      CASSANDRA_SEEDS: cassandra1,cassandra2
      CASSANDRA_ENDPOINT_SNITCH: GossipingPropertyFileSnitch
      CASSANDRA_BROADCAST_ADDRESS: "cassandra2"
      CASSANDRA_STORAGE_PORT: 7001
      CASSANDRA_AUTHENTICATOR: AllowAllAuthenticator
      CASSANDRA_AUTHORIZER: AllowAllAuthorizer
      CASSANDRA_DATACENTER: dc1Test
      CASSANDRA_RACK: rack1Test
      MAX_HEAP_SIZE: 1G
      HEAP_NEWSIZE: 200M
    volumes:
      - ./containervolumes/cassandra2/data:/opt/cassandra/data
      - ./containervolumes/cassandra2/logs:/opt/cassandra/logs

  wesley:
    image: cfei/wesley:0.3
    restart: on-failure
    environment:
      KAFKA_SUBDB: /var/log/wesley/kafka_subscriptions.txt
      KAFKA_BROKERS: "stage1.cfei.dk:9092,stage2.cfei.dk:9092,stage3.cfei.dk:9092"
      KAFKA_GROUP: uniten_archiver
      KAFKA_PREFIX: uniten_archiver
      MYSQL_HOST: wesley-mysql
      MYSQL_PORT: 3306
      MYSQL_USER: archiver
      MYSQL_PASSWORD: "${WESLEY_MYSQL_PASSWORD}"
      MYSQL_DATABASE: metadata
      CASSANDRA_HOSTS: cassandra1,cassandra2
      CASSANDRA_PORT: 9042
      CASSANDRA_KEYSPACE: data
      CASSANDRA_TABLE_PREFIX: prefix_is_currently_hardcoded
    volumes:
      - ./containervolumes/wesley-logs:/var/log/wesley
    depends_on:
      - wesley-mysql
      - cassandra1
      - cassandra2
      - kafka1
      - kafka2
      - kafka3